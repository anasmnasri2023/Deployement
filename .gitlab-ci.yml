variables:
  DOCKER_USERNAME: "anasmnasri"
  IMAGE_BACKEND: "$DOCKER_USERNAME/node-app"
  IMAGE_FRONTEND: "$DOCKER_USERNAME/react-app"

stages:
  - install
  - test
  - build

install-backend:
  stage: install
  image: node:18
  cache:
    key: backend-cache
    paths:
      - E-LearningBackend/node_modules/
  script:
    - cd E-LearningBackend
    - npm install
    - npm install --save-dev mocha chai

install-frontend:
  stage: install
  image: node:18
  cache:
    key: frontend-cache
    paths:
      - E-LearningFrontend/node_modules/
  script:
    - cd E-LearningFrontend
    - npm install

test-backend:
  stage: test
  image: node:18
  cache:
    key: backend-cache
    paths:
      - E-LearningBackend/node_modules/
  script:
    - cd E-LearningBackend
    - if [ -d "test" ]; then npx mocha --recursive --timeout 10000; else echo "Aucun test trouv√©"; fi

test-frontend:
  stage: test
  image: node:18
  cache:
    key: frontend-cache
    paths:
      - E-LearningFrontend/node_modules/
  script:
    - cd E-LearningFrontend
    - CI=true npm test -- --watchAll=false --passWithNoTests

build-push-backend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker build -t $IMAGE_BACKEND ./E-LearningBackend
    - docker push $IMAGE_BACKEND
    - docker logout

build-push-frontend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker build -t $IMAGE_FRONTEND ./E-LearningFrontend
    - docker push $IMAGE_FRONTEND
    - docker logout